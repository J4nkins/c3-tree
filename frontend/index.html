<!DOCTYPE html>
<html>
  <head>
    <title>C3Tree</title>
    <meta charset="utf-8" />

    <style type="text/css">
      html, body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      .canvas-wrapper {
        margin: 0 auto;
      }
      #controls-wrapper {
        position: absolute;
        width: 200px;
      }
      .tooltip {
        position: absolute;
        pointer-events: none;
        background: #ffffff;
        border: 1px solid #f0f0f0;
        box-shadow: 3px 3px 7px 1px rgba(0,0,0,0.15);
        -webkit-box-shadow: 3px 3px 7px 1px rgba(0,0,0,0.15);
        -moz-box-shadow: 3px 3px 7px 1px rgba(0,0,0,0.15);
        -webkit-border-radius: 0.2em;border-radius: 0.2em;
      }
      .tooltip-title {
        font-weight: bold;
        font-size: 120%;
        margin-top: 20px;
      }
      .tooltip table {
        width: 100%;
        padding: 10px;
      }
      .tooltip table tr, .tooltip table td, .tooltip table p {
        padding: 0;
        margin: 0;
        border-spacing: 0;
      }
      .tooltip table td a {
        text-decoration: none;
        font-weight: bold;
        text-transform: lowercase;
        font-size: 80%;
      }
      .tooltip-close-button {
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 22px;
        font-family: arial;
        cursor: pointer;
      }
      .tooltip-bottom-note {
        color: #a0a0a0;
        font-size: 80%;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    
    <div id="loader" style="position: absolute; left: 50%; top: 50%; width: 400px; height: 300px; margin: -150px 0 0 -200px;text-align: center">
      <span>Welcome!<br/>Now loading data from Google Sheet API...</span>
      <img src="/loading_bars.svg" alt="loading-bars"/>
    </div>


    <div id="tooltip-wrapper">
      <div id="hover-tooltip" class="tooltip" style="display:none">
        <div class="tooltip-close-button" style="display:none">x</div>
        <center>
          <div class="tooltip-title"></div>
        </center>
        <table cellspacing="15">
          <tbody class="tooltip-tbody"></tbody>
        </table>
        <center><div class="tooltip-bottom-note">Click on the leaf to stick.</div></center>
      </div>
    </div>

    <div id="controls-wrapper" style="display:none">
      <center>
        <select id="viz-select">
          <option value="0">Radial Tree</option>
          <option value="1">Connected Edges</option>
        </select>
      </center>
    </div>

    <div class="canvas-wrapper">
      <svg id="d3-canvas" opacity="0.0"/>
    </div>

    <script src="/d3/dist/d3.min.js"></script>

    <script type="text/javascript">

      const getParentWidthDepth = (d, depth) => {
        let parent = d.parent;
        while(parent && parent.depth > depth)
          parent = parent.parent;
        return depth === parent?.depth ? parent : null;
      }

      d3.select("#viz-select").on("change", (event) => {
        if(event.target.value === "0") {
          d3.selectAll(".curves-wrapper-center").attr("opacity", 1.0);
          d3.selectAll(".curves-wrapper-leaves").attr("opacity", 0.0);
        } else {
          d3.selectAll(".curves-wrapper-center").attr("opacity", 0.0);
          d3.selectAll(".curves-wrapper-leaves").attr("opacity", 1.0);
        }
      });

      const margin = {
        top: 60,
        right: 60,
        bottom: 60,
        left: 60,
      }
      const width  = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
      const height = (window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight);
      let canvasWidth = width;
      let canvasHeight = height;
      if(width < height) {
        d3.select("#controls-wrapper").style("left", "50%").style("top", `${(height - width) / 2.0 - 20}px`).style("margin-left", "-100px");
        d3.selectAll(".canvas-wrapper").style("margin-top", `${(height - width) / 2.0}px`)
        canvasHeight = width;
      } else {
        d3.select("#controls-wrapper").style("left", `${(width - height) / 2.0 - 220}px`).style("top", `35%`)
        canvasWidth = height;
      }
      d3.select("#controls-wrapper").style("display", "block");
      d3.selectAll(".canvas-wrapper").style("width", `${canvasWidth}px`).style("height", `${canvasHeight}px`)

      const tooltipWidth = 500;
      d3.select("#hover-tooltip").style("width", `${tooltipWidth}px`).style("height", "auto")

      const radius = d3.min([canvasWidth - margin.left - margin.right, canvasHeight - margin.top - margin.bottom]) / 2 - 50;

      const radialTreeLine = d3.linkRadial()
        .source((d) => ({
            x: d.source.x,
            y: d.source.y + (d.source.parent ? (d.source.parent.y - d.source.y) * 0.7 : 0),
        }))
        .target((d) => ({
            x: d.target.x,
            y: d.target.y + (d.target.parent && d.target.children ? (d.target.parent.y - d.target.y) * 0.7 : 0),
        }))
        .angle((d) => d.x)
        .radius((d) => d.y);
      const connectedEdgesLine = d3.lineRadial().curve(d3.curveBundle.beta(0.9)).radius((d) => d.y).angle((d) => d.x);
      const separation = (a, b) => a.parent == b.parent ? 1 : 2;





      const rerenderTree = (data) => {

        const root = d3.hierarchy(data);

        const treeFunction = d3.cluster().size([2 * Math.PI, radius]);
        treeFunction.separation(separation)(root);

        /*d3.selectAll(".category-labels")
          .data(data.children)
          .attr("transform", (d, i) => `translate(
            ${[0,3].includes(i) ? canvasWidth / 2.0 - radius : canvasWidth / 2.0 + radius},
            ${[0,1].includes(i) ? margin.top : canvasHeight - margin.bottom})`)
          .attr("text-anchor", (d, i) => [0,3].includes(i) ? "middle" : "middle")
          .attr("dominant-baseline", "middle")
          .attr("font-size", "20px")
          .attr("font-weight", "bold")
          .attr("fill", (d) => d.color)
          .text((d) => d.text);*/

        // curves from center to leaves
        console.log(d3.selectAll(".center-to-leaf-path"));
        d3.selectAll(".center-to-leaf-path")
          .data(root.links())
          .attr("d", radialTreeLine)
          .attr("stroke", (d) => d.target.data.color)
          .attr("stroke-width", 1.5)
          .attr("opacity", (d) => d.source.data.depth > 0 ? 1.0 : 0.0);

        console.log(d3.selectAll(".node-group"));
        console.log(root.descendants().map((d) => d.data.id));
        d3.selectAll(".node-group")
          .data(root.descendants())
          .attr("transform", (d) => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y + (d.parent && d.children ? (d.parent.y - d.y) * 0.7 : 0)},0)`);

        d3.selectAll(".node-text")
          .attr("transform", (d) => `rotate(${d.x >= Math.PI ? 180 : 0})`)
          .attr("x", (d) => d.x < Math.PI === !d.children ? 6 : -6)
          .attr("text-anchor", (d) => d.x < Math.PI === !d.children ? "start" : "end")
          .attr("opacity", (d) => d.data.depth > 2 ? 1.0 : 0.0);

        d3.selectAll(".node-circle")
          .attr("fill", (d) => d.data.color)
          //.attr("opacity", (d) => d.children ? 0.0 : 1.0)
          .attr("opacity", (d) => d.depth === 0 ? 0.0 : 1.0)
          .attr("r", (d) => d.children ? 4 : 2);

        d3.selectAll(".node-interact-area")
          .on("click", (event, d) => {
            const children = d.data.children;
            d.data.children = null;
            d.data.previouschildren = children;
            rerenderTree(data);
          });
      }






      const createCollapsableRadialTree = (data) => {

        console.log(data);

        const root = d3.hierarchy(data);
        
        const treeFunction = d3.cluster().size([2 * Math.PI, radius]);
        treeFunction.separation(separation)(root);

        d3.select("#loader").style("display", "none");
        d3.select("#d3-canvas").selectAll("*").remove();
        const svg = d3.select("#d3-canvas")
          .attr("opacity", 1.0)
          .attr("viewBox", [0, 0, canvasWidth, canvasHeight])
          .attr("width", canvasWidth)
          .attr("height", canvasHeight)
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .append("g")
          .attr("transform", `translate(${canvasWidth / 2.0},${canvasHeight / 2.0}) rotate(-70)`);

        // center image
        const brainAspectRatio = 0.822;
        const brainSize = 0.65;
        d3.select("#d3-canvas")
          .append("image")
          .attr("opacity", 0.0)
          .attr("href", "/brain.png")
          .attr("width", radius * brainSize)
          .attr("height", radius * brainSize * brainAspectRatio)
          .attr("transform", `translate(
            ${width / 2.0 - radius * brainSize / 2.0},
            ${height / 2.0 - radius * brainSize / 2.0 * brainAspectRatio})`);


        // research questions text in the corners (currently only works with 4)
        d3.select("#d3-canvas").append("g")
          .selectAll(".category-labels")
          .data(data.children)
          .join("text")
          .attr("class", "category-labels")
          .attr("transform", (d, i) => `translate(
            ${[0,3].includes(i) ? canvasWidth / 2.0 - radius : canvasWidth / 2.0 + radius},
            ${[0,1].includes(i) ? margin.top : canvasHeight - margin.bottom})`)
          .attr("text-anchor", (d, i) => [0,3].includes(i) ? "middle" : "middle")
          .attr("dominant-baseline", "middle")
          .attr("font-size", "20px")
          .attr("font-weight", "bold")
          .attr("fill", (d) => d.color)
          .text((d) => d.text)

        // curves from center to leaves
        svg.append("g")
          .attr("class", "curves-wrapper-center")
          .attr("fill", "none")
          .attr("opacity", 0.0)
          .selectAll(".center-to-leaf-path")
          .data(root.links())
          .join("path")
            .attr("class", "center-to-leaf-path")
            .attr("d", radialTreeLine)
            .attr("stroke", (d) => d.target.data.color)
            .attr("stroke-width", 1.5)
            .attr("opacity", (d) => d.source.data.depth > 0 ? 1.0 : 0.0);

        // curves from leaf to leaf (connected edges)
        const leaves = root.leaves();
        svg.append("g")
          .attr("class", "curves-wrapper-leaves")
          .attr("fill", "none")
          .attr("opacity", 0.0)
          .selectAll("path")
          .data(leaves.flatMap((leaf) => {
            return leaves.filter(
              (d) => d.data.props.data_source === leaf.data.props.data_source && d !== leaf).map(
              (d) => [leaf, d]);
          }))
          .join("path")
            .attr("data-connection-data-source", (d) => `${d[0].data.props.data_source}`)
            .attr("fill", "tansparent")
            .attr("stroke", "#d0d0d0")
            .attr("stroke-width", 1.0)
            .attr("opacity", 0.5)
            .attr("d", ([i, o]) => connectedEdgesLine(i.path(o)));

        // texts (leaves etc.)
        const node = svg.append("g")
          .selectAll(".node-group")
          .data(root.descendants())
          .join("g")
            .attr("class", "node-group")
            .attr("transform", (d) => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y + (d.parent && d.children ? (d.parent.y - d.y) * 0.7 : 0)},0)`);

        node.append("text")
          .attr("class", "node-text")
          .attr("id", (d) => `${d.data.id}-text`)
          .attr("transform", (d) => `rotate(${d.x >= Math.PI ? 180 : 0})`)
          .attr("dy", "0.32em")
          .attr("x", (d) => d.x < Math.PI === !d.children ? 6 : -6)
          .attr("text-anchor", (d) => d.x < Math.PI === !d.children ? "start" : "end")
          .attr("paint-order", "stroke")
          .attr("stroke", "white")
          .attr("stroke-width", 3)
          .attr("opacity", (d) => d.data.depth > 2 ? 1.0 : 0.0)
          .attr("fill", (d) => d.data.color)
          .attr("font-size", "10px")
          .style("pointer-events", "none")
          .text((d) => d.data.text);
        node.filter((d) => !d.children).append("rect")
          .attr("class", "text-leaf-interact-area")
          .attr("fill", "transparent")
          .attr("opacity", 0.5)
          .attr("y", -10)
          .attr("width", 100)
          .attr("height", 30)
          .style("pointer-events", "all")
          .style("cursor", "pointer")
          .on("click", (event, d) => {
            if(d3.select(`#sticky-tooltip-${d.data.id}`).empty()) {
              const stickyTooltip = d3.select("#hover-tooltip.tooltip").clone(true).attr("id", `sticky-tooltip-${d.data.id}`);
              d3.select("#hover-tooltip.tooltip").style("display", "none")
              stickyTooltip.style("pointer-events", "all");
              stickyTooltip.select(".tooltip-close-button")
                .style("display", "block")
                .on("click", () => d3.select(`#sticky-tooltip-${d.data.id}`).remove());
            } else {
              d3.select(`#sticky-tooltip-${d.data.id}`).remove();
              d3.select("#hover-tooltip.tooltip").style("display", "block")
            }
          })
          .on("mouseover", (event, d) => {
            const pointerPos = [event.pageX, event.pageY];
            d3.select("#hover-tooltip .tooltip-title")
              .text(d.data.text)

            d3.select("#hover-tooltip .tooltip-tbody").selectAll("*").remove();
            const topic = getParentWidthDepth(d, 1);
            const topicRow = d3.select("#hover-tooltip .tooltip-tbody").append("tr");
            topicRow.append("td").style("width", `${tooltipWidth * 0.35}px`)
              .append("p")
              .style("font-weight", "bold")
              .text("Topic")
            topicRow.append("td").append("p").text(topic.data.text);
            const researchQuestion = getParentWidthDepth(d, 2);
            const researchQuestionRow = d3.select("#hover-tooltip .tooltip-tbody").append("tr");
            researchQuestionRow.append("td").style("width", `${tooltipWidth * 0.35}px`)
              .append("p")
              .style("font-weight", "bold")
              .text("Research Question")
            researchQuestionRow.append("td").append("p").text(researchQuestion.data.text);
            const subquestion = getParentWidthDepth(d, 3);
            if(subquestion) {
              const subquestionRow = d3.select("#hover-tooltip .tooltip-tbody").append("tr");
              subquestionRow.append("td").style("width", `${tooltipWidth * 0.35}px`)
                .append("p")
                .style("font-weight", "bold")
                .text("Subquestion")
              subquestionRow.append("td").append("p").text(subquestion.data.text);
            }
            if(d.data.props.link) {
              const linkRow = d3.select("#hover-tooltip .tooltip-tbody").append("tr");
              linkRow.append("td").style("width", `${tooltipWidth * 0.35}px`)
                .append("p")
                .style("font-weight", "bold")
                .text("Link")
              linkRow.append("td")
                .append("a")
                .attr("href", d.data.props.link)
                .attr("target", "_blank")
                .text(d.data.props.link.split("/").length > 3 ? d.data.props.link.split("/")[2].replace("www.","") : "Click me");
            }

            if(d3.select(`#sticky-tooltip-${d.data.id}`).empty()) {
              d3.select("#hover-tooltip.tooltip")
                .style("left", `${pointerPos[0] + 10}px`)
                .style("top", `${pointerPos[1] + 10}px`)
                .style("display", "block")
                .raise();
            }

            d3.select(`#${d.data.id}-text`).style("font-weight", "bold");
            d3.selectAll(`path[data-connection-data-source="${d.data.props.data_source}"]`)
              .attr("stroke", "#86A2F4")
              .raise();
          })
          .on("mousemove", (event, d) => {
            if(d3.select(`#sticky-tooltip-${d.data.id}`).empty()) {
              const boundingRect = d3.select("#hover-tooltip.tooltip").node().getBoundingClientRect();
              const pointerPos = [event.pageX, event.pageY];
              const left = event.pageX + tooltipWidth >= width - 20 ? event.pageX - tooltipWidth - 10 : event.pageX + 10;
              const top = event.pageY + boundingRect.height >= height - 20 ? event.pageY - boundingRect.height - 10 : event.pageY + 10;
              d3.select("#hover-tooltip.tooltip")
                .style("left", `${left}px`)
                .style("top", `${top}px`);
            }
          })
          .on("mouseleave", (event, d) => {
            d3.select("#hover-tooltip.tooltip").style("display", "none");
            d3.select(`#${d.data.id}-text`).style("font-weight", null);
            d3.selectAll(`path[data-connection-data-source="${d.data.props.data_source}"]`)
              .attr("stroke", "#d0d0d0");
          });

        // leaf nodes
        node.append("circle")
          .attr("class", "node-circle")
          .attr("fill", (d) => d.data.color)
          //.attr("opacity", (d) => d.children ? 0.0 : 1.0)
          .attr("opacity", (d) => d.depth === 0 ? 0.0 : 1.0)
          .attr("r", (d) => d.children ? 4 : 2);

        node.filter((d) => d.depth !== 0 && d.children).append("circle")
          .attr("class", "node-interact-area")
          .attr("fill", "transparent")
          .attr("opacity", 0.0)
          .attr("r", 8)
          .style("pointer-events", "all")
          .style("cursor", "pointer")
          .on("click", (event, d) => {
            return;
            const children = d.data.children;
            d.data.children = null;
            d.data.previouschildren = children;
            console.log(root.descendants().map((d) => d.data.id));
            rerenderTree(data);
          });

        if(d3.select("#viz-select").node().value === "0") {
          d3.selectAll(".curves-wrapper-center").attr("opacity", 1.0);
          d3.selectAll(".curves-wrapper-leaves").attr("opacity", 0.0);
        } else {
          d3.selectAll(".curves-wrapper-center").attr("opacity", 0.0);
          d3.selectAll(".curves-wrapper-leaves").attr("opacity", 1.0);
        }
      }

    </script>

    <script type="text/javascript">

      const colors = ["#8C88BA", "#BF84AE", "#DB95AC", "#FBB9A6", "#F6A294"];

      const buildHierarchy = ((parentLevel, data, depth) => {
        data.filter((d) => d.parent === parentLevel.text).forEach((d) => {

          const level = {
            "id": `${parentLevel.id}${parentLevel.children.length}`,
            "text": d.text,
            "color": depth === 1
              ? (parentLevel.children.length < colors.length ? colors[parentLevel.children.length] : "#808080")
              : parentLevel.color,
            "depth": depth,
            "props": {
              "link": d.link,
              "data_source": d.data_source,
            },
            "children": [],
          };

          console.log(level.id);

          parentLevel.children.push(level);
          buildHierarchy(level, data, depth + 1);
        });
      });

      const parseSheetData = ((data) => {
        
        const hierarchyRootLevel = {
          "id": "r",
          "text": "ROOT",
          "color": "#202020",
          "depth": 0,
          "props": {},
          "children": [],
        };

        buildHierarchy(hierarchyRootLevel, data, 1);

        return hierarchyRootLevel;
      });

      window.addEventListener("load", (event) => {
        
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/fetch_c3tree_data_from_google_sheet", true);
        xhr.send(null);
        xhr.onload = () => {
          
          if(xhr.readyState === 4) {
            if(xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              const hierarchyRootLevel = parseSheetData(response.data[0][0] === "text" 
                ? response.data.map((d) => ({
                    text: d[0],
                    parent: d[1],
                    link: d[2],
                    data_source: d[3]
                  }))
                : response.data);
              createCollapsableRadialTree(hierarchyRootLevel);  
            } else {

            }
          }
        }

        xhr.onerror = (err) => {
          console.log(err);
        }
        
      });

    </script>


  </body>
</html>